function t(t,e){const s=e.loopStart,a=e.data;return t<s?a[t]:(t-=s,a[s+(t%=a.length-s)])}function e(e,s){let a=Math.floor(e);if(s.linear){const i=e-a,h=t(a,s);return h+i*(t(a+1,s)-h)}return t(a,s)}const s=2*Math.PI;function a(t,e,s){return t<e?e:t>s?s:t}function i(t,e=0,i=0){const h=a(e,-1,1),n=.5*Math.PI*a(i,-.999999,.999999);return 4*Math.atan2((1+h)*Math.sin(s*t),(1-h)*Math.cos(4*Math.PI*t+n))/(3*Math.PI)}function h(t,e=0,s=0){const i=t-Math.floor(t+.5),h=a(e,-1,1),n=Math.PI/6*a(s,-.999999,.999999);return 2*Math.atan2((1+h)*Math.sin(3*Math.PI*i),(1-h)*Math.cos(Math.PI*i+n))/Math.PI+2*i}function n(t,e=0,i=0){const h=t-Math.floor(t+.5),n=a(e,-1,1),o=Math.PI/6*a(i,-.999999,.999999);let r=Math.atan2((1+n)*Math.sin(6*Math.PI*h),(1-n)*Math.cos(4*Math.PI*h+o));return h>0&&r<0&&(r+=s),h<0&&r>0&&(r-=s),4*r/(5*Math.PI)}function o(t,e=0,i=0){const h=t-Math.floor(t+.5),n=a(e,-1,1),o=.1*Math.PI*a(i,-.999999,.999999);let r=Math.atan2((-1-n)*Math.sin(10*Math.PI*h),(1-n)*Math.cos(4*Math.PI*h+o));return.15<h&&h<.35&&r<0&&(r+=s),-.35<h&&h<-.15&&r>0&&(r-=s),4*r/(5*Math.PI)}function r(t,e=0,i=0){const h=t-Math.floor(t+.5),n=a(e,-1,1),o=Math.PI/6*a(i,-.999999,.999999);let r=Math.atan2((1-n)*Math.sin(6*Math.PI*h),(1+n)*Math.cos(8*Math.PI*h+o));return.1<h&&h<.4&&r<=0&&(r+=s),-.4<h&&h<-.1&&r>=0&&(r-=s),4*r/(7*Math.PI)}function l(t,e=0,i=0){const h=t-Math.floor(t+.5),n=a(e,-1,1),o=.1*Math.PI*a(i,-.999999,.999999);let r=Math.atan2((1+n)*Math.sin(5*Math.PI*h),(1-n)*Math.cos(3*Math.PI*h+o));return h>0&&r<0&&(r+=s),h<0&&r>0&&(r-=s),r/Math.PI-h}class f extends AudioWorkletProcessor{constructor(t){super(t),this.tOnset=0,this.tableDelta=.02,this.tables={},this.messages=[],this.port.onmessage=this.onMessage.bind(this)}onMessage(t){const e=t.data.when;void 0===e?this.applyMessage(t):(this.messages.push([e,t]),this.messages.sort(((t,e)=>t[0]-e[0])))}triggerMessages(t){for(;this.messages.length&&this.messages[0][0]<=t;){const[t,e]=this.messages.shift();this.applyMessage(e)}}applyMessage(t){const e=t.data;return"onset"===e.type?(this.tOnset=0,!0):"cancel"===e.type?(this.messages=[],!0):"tableDelta"===e.type?(this.tableDelta=e.value,!0):"tables"===e.type?(this.tables=e.value,!0):"table"===e.type&&(this.tables[e.subtype]=e.value,!0)}process(t,e,s){const a=e[0];this.processMono(a[0],s);for(let t=1;t<a.length;++t)for(let e=0;e<a[0].length;++e)a[t][e]=a[0][e];return!0}getDt(){return 1/sampleRate}getLowpass(t){return.5**(t/.001)}}const u=2*Math.PI;function c(t){return Math.sin(u*t)}function M(t){return Math.cos(u*t)}function p(t){return 2*Math.abs(Math.cos(Math.PI*t))-1}function m(t){return 2*(t-Math.floor(t+.5))}const v=2/Math.PI;function b(t,e){return e<1e-6?c(t):e>=1?function(t){return 4*(.25-Math.abs(t-Math.floor(t+.25)-.25))}(t):Math.asin(e*c(t))/Math.asin(e)}function g(t,e){return e<1e-6?c(t):e>.999999?function(t){return 2*(t-Math.floor(t)<.5)-1}(t):(e/=1-e,Math.atan(c(t)*e)/Math.atan(e))}const d=2*Math.PI;function w(t){return Math.sqrt(Math.max(0,t))}function P(t,e){return function(t,e){return e<1e-6?M(t):e>=1?p(t):(Math.hypot((1+e)*Math.cos(Math.PI*t),(1-e)*Math.sin(Math.PI*t))-1)/e}(t-.25,e)}function y(t,e){return function(t,e){return e<1e-6?c(t):e>.999999?m(t):Math.atan(e*c(t)/(1+e*M(t)))/Math.asin(e)}(t,w(e))}function I(t,e){return b(t,w(e))}function D(t,e){return g(t,w(e))}function O(t,e,s){return function(t,e,s){return e<1e-6?M(t):(Math.exp(c(t+s)*e)-Math.exp(c(t-s)*e))/((Math.exp(e)-Math.exp(-e))*c(s)*(1+(.25-s)*e))}(t,12*e,.25-.2499*s)}function x(t,e){return function(t,e){return e<1e-6?-M(t):2*(Math.cosh(Math.sin(Math.PI*t)*e)-1)/(Math.cosh(e)-1)-1}(t-.25,12*e)}function L(t,e){return function(t,e){return e<1e-6?c(t):Math.tanh(c(t)*e)/Math.tanh(e)}(t+.25,12*e)}function j(t,e){return function(t,e){if(e<1e-6)return c(t);if(e>.999999)return 1;const s=Math.log1p(-e);return(Math.log1p(c(t)*e)-s)/(Math.log1p(e)-s)*2-1}(t,.99*Math.min(1,e))}function k(t,e,s){return function(t,e,s){if(e<1e-6)return M(t);if(e>.999999)return m(t+s)-m(t-s);const a=e*c(t),i=c(s),h=e*M(t),n=M(s),o=a*n,r=h*i,l=h*n,f=a*i;return(Math.atan((o+r)/(1+l-f))-Math.atan((o-r)/(1+l+f)))*(.5+e*(v-.5))/(e*(i+(1-i)*e))}(t,w(e),.25-.24*s)}function S(t,e,s){return function(t,e,s){if(e<1e-6)return-c(t);if(e>=1)return.5*(p(t+s)-p(t-s))/c(s);const a=1+e,i=1-e,h=Math.PI*(t+s),n=Math.PI*(t-s);return(Math.hypot(a*Math.cos(h),i*Math.sin(h))-Math.hypot(a*Math.cos(n),i*Math.sin(n)))/(2*e*c(s))}(t,e,.25-.245*s)}const z=[i,h,n,o,r,l,k,S,O];function V(t,e){return t-=Math.floor(t+.5),Math.abs(t)<e?.25*t/e:t>0?.25+.25*(t-e)/(.5-e):.25*(t+e)/(.5-e)-.25}class q extends f{static get parameterDescriptors(){return[{name:"nat",defaultValue:0},{name:"timbre",defaultValue:0},{name:"bias",defaultValue:0}]}constructor(){super(),this.phase=0,this.differentiated=!1,this.timbre=0,this.bias=0,this.amplitude=1,this.waveform=k,this.biasable=z.includes(this.waveform),this.tables={amplitude:{linear:!1,loopStart:0,data:[1]},nat:{linear:!1,loopStart:0,data:[0]},timbre:{linear:!1,loopStart:0,data:[0]},bias:{linear:!1,loopStart:0,data:[0]}}}applyMessage(t){if(super.applyMessage(t))return;const e=t.data;if("waveform"===e.type){if("semisine"===e.value)this.waveform=P;else if("sawtooth"===e.value)this.waveform=y;else if("triangle"===e.value)this.waveform=I;else if("square"===e.value)this.waveform=D;else if("sinh"===e.value)this.waveform=O;else if("cosh"===e.value)this.waveform=x;else if("tanh"===e.value)this.waveform=L;else if("log"===e.value)this.waveform=j;else if("pulse"===e.value)this.waveform=k;else if("tent"===e.value)this.waveform=S;else if("Lissajous 2 1"===e.value)this.waveform=i;else if("Lissajous 1 3"===e.value)this.waveform=h;else if("Lissajous 2 3"===e.value)this.waveform=n;else if("Lissajous 2 5"===e.value)this.waveform=o;else if("Lissajous 3 4"===e.value)this.waveform=r;else{if("Lissajous 3 5"!==e.value)throw`Unrecognized waveform ${e.value}`;this.waveform=l}this.biasable=z.includes(this.waveform)}else{if("differentiated"!==e.type)throw`Unrecognized message ${e.type}`;this.differentiated=e.value}}processMono(t,s){let i=currentTime;const h=s.nat,n=s.timbre,o=s.bias,r=this.getDt(),l=this.getLowpass(r),f=1-l;for(let s=0;s<t.length;s++){this.triggerMessages(i);const u=this.tOnset/this.tableDelta,c=Math.exp(h[Math.min(h.length-1,s)]+e(u,this.tables.nat)),M=n[Math.min(n.length-1,s)]+e(u,this.tables.timbre),p=o[Math.min(o.length-1,s)]+e(u,this.tables.bias),m=e(u,this.tables.amplitude),v=this.timbre=this.timbre*l+M*f,b=this.bias=a(this.bias*l+p*f,0,1),g=this.amplitude=this.amplitude*l+m*f,w=c*r;let P;if(this.biasable)P=this.differentiated?(this.waveform(this.phase+w,v,b)-this.waveform(this.phase,v,b))/(w*d):.5*(this.waveform(this.phase,v,b)+this.waveform(this.phase+.5*w,v,b));else{const t=.25+.25*b;if(this.differentiated){const e=V(this.phase,t),s=V(this.phase+w,t);P=(this.waveform(s,v)-this.waveform(e,v))/(w*d)}else{const e=V(this.phase,t),s=V(this.phase+.5*w,t);P=.5*(this.waveform(e,v)+this.waveform(s,v))}}t[s]=P*g,i+=r,this.tOnset+=r,this.phase+=w,this.phase-=Math.floor(this.phase)}}}const T=2*Math.PI;registerProcessor("monophone",q),registerProcessor("polyphone",class extends q{constructor(){super(),delete this.phase,delete this.timbre,delete this.bias,delete this.amplitude;const t=this.getDt();this.attackDecay=.1**t,this.releaseDecay=.001**t,this.voices=new Map}applyMessage(t){const s=t.data;if("onset"===s.type){const t=this.voices.get(s.id)||{};return t.tOnset=0,t.tOffset=-1,t.nats=s.nats,t.velocity=s.velocity,t.timbre=t.timbre||e(0,this.tables.timbre),t.bias=t.bias||e(0,this.tables.bias),t.amplitude=t.amplitude||e(0,this.tables.amplitude),t.envelope=t.envelope||0,t.phase=t.phase||0,void this.voices.set(s.id,t)}if("offset"!==s.type)if("attack"!==s.type)if("release"!==s.type)super.applyMessage(t),"cancel"===s.type&&this.voices.clear();else{const t=this.getDt();this.releaseDecay=.3**(t/s.value)}else{const t=this.getDt();this.attackDecay=.3**(t/s.value)}else{this.voices.get(s.id).tOffset=0}}processMono(t,s){let i=currentTime;const h=this.getDt();if(!this.voices.size){for(let e=0;e<t.length;e++)this.triggerMessages(i),i+=h;return}const n=s.nat,o=s.timbre,r=s.bias,l=this.getLowpass(h),f=1-l;for(let s=0;s<t.length;s++){this.triggerMessages(i);const u=n[Math.min(n.length-1,s)],c=o[Math.min(o.length-1,s)],M=r[Math.min(r.length-1,s)];t[s]=0;for(let[i,n]of this.voices){if(n.tOffset>1&&n.envelope<1e-4){this.voices.delete(i);continue}const o=n.tOnset/this.tableDelta,r=Math.exp(n.nats+u+e(o,this.tables.nat)),p=c+e(o,this.tables.timbre),m=M+e(o,this.tables.bias),v=e(o,this.tables.amplitude),b=n.timbre=n.timbre*l+p*f,g=n.bias=a(n.bias*l+m*f,0,1),d=n.amplitude=n.amplitude*l+v*f;n.tOffset<0?n.envelope=(1-this.attackDecay)*n.velocity+this.attackDecay*n.envelope:(n.envelope*=this.releaseDecay,n.tOffset+=h);const w=r*h;let P;if(this.biasable)P=this.differentiated?(this.waveform(n.phase+w,b,g)-this.waveform(n.phase,b,g))/(w*T):.5*(this.waveform(n.phase,b,g)+this.waveform(n.phase+.5*w,b,g));else{const t=.25+.25*g;if(this.differentiated){const e=V(n.phase,t),s=V(n.phase+w,t);P=(this.waveform(s,b)-this.waveform(e,b))/(w*T)}else{const e=V(n.phase,t),s=V(n.phase+.5*w,t);P=.5*(this.waveform(e,b)+this.waveform(s,b))}}t[s]+=P*d*n.envelope,n.tOnset+=h,n.phase+=w,n.phase-=Math.floor(n.phase)}i+=h}}});
