class t extends AudioWorkletProcessor{constructor(t){super(t),this.tOnset=0,this.tableDelta=.02,this.tables={},this.messages=[],this.port.onmessage=this.onMessage.bind(this)}onMessage(t){const e=t.data.when;void 0===e?this.applyMessage(t):(this.messages.push([e,t]),this.messages.sort(((t,e)=>t[0]-e[0])))}triggerMessages(t){for(;this.messages.length&&this.messages[0][0]<=t;){const[t,e]=this.messages.shift();this.applyMessage(e)}}applyMessage(t){const e=t.data;return"onset"===e.type?(this.tOnset=0,!0):"cancel"===e.type?(this.messages=[],!0):"tableDelta"===e.type?(this.tableDelta=e.value,!0):"tables"===e.type?(this.tables=e.value,!0):"table"===e.type&&(this.tables[e.subtype]=e.value,!0)}process(t,e,a){const s=e[0];this.processMono(s[0],a);for(let t=1;t<s.length;++t)for(let e=0;e<s[0].length;++e)s[t][e]=s[0][e];return!0}getDt(){return 1/sampleRate}getLowpass(t){return.5**(t/.001)}}function e(t,e){const a=e.loopStart,s=e.data;return t<a?s[t]:(t-=a,s[a+(t%=s.length-a)])}function a(t,a){let s=Math.floor(t);if(a.linear){const n=t-s,i=e(s,a);return i+n*(e(s+1,a)-i)}return e(s,a)}const s=2*Math.PI;function n(t){return Math.sin(s*t)}function i(t){return Math.cos(s*t)}function h(t){return 2*Math.abs(Math.cos(Math.PI*t))-1}function r(t){return 2*(t-Math.floor(t+.5))}const o=2/Math.PI;function u(t,e){return e<1e-6?n(t):e>=1?function(t){return 4*(.25-Math.abs(t-Math.floor(t+.25)-.25))}(t):Math.asin(e*n(t))/Math.asin(e)}function l(t,e){return e<1e-6?n(t):e>.999999?function(t){return 2*(t-Math.floor(t)<.5)-1}(t):(e/=1-e,Math.atan(n(t)*e)/Math.atan(e))}const f=2*Math.PI;function M(t,e,a){return t<e?e:t>a?a:t}function c(t,e=0,a=0){const s=M(e,-1,1),n=.5*Math.PI*M(a,-.999999,.999999);return 4*Math.atan2((1+s)*Math.sin(f*t),(1-s)*Math.cos(4*Math.PI*t+n))/(3*Math.PI)}function p(t,e=0,a=0){const s=t-Math.floor(t+.5),n=M(e,-1,1),i=Math.PI/6*M(a,-.999999,.999999);return 2*Math.atan2((1+n)*Math.sin(3*Math.PI*s),(1-n)*Math.cos(Math.PI*s+i))/Math.PI+2*s}function m(t,e=0,a=0){const s=t-Math.floor(t+.5),n=M(e,-1,1),i=Math.PI/6*M(a,-.999999,.999999);let h=Math.atan2((1+n)*Math.sin(6*Math.PI*s),(1-n)*Math.cos(4*Math.PI*s+i));return s>0&&h<0&&(h+=f),s<0&&h>0&&(h-=f),4*h/(5*Math.PI)}function v(t,e=0,a=0){const s=t-Math.floor(t+.5),n=M(e,-1,1),i=.1*Math.PI*M(a,-.999999,.999999);let h=Math.atan2((-1-n)*Math.sin(10*Math.PI*s),(1-n)*Math.cos(4*Math.PI*s+i));return.15<s&&s<.35&&h<0&&(h+=f),-.35<s&&s<-.15&&h>0&&(h-=f),4*h/(5*Math.PI)}function g(t,e=0,a=0){const s=t-Math.floor(t+.5),n=M(e,-1,1),i=Math.PI/6*M(a,-.999999,.999999);let h=Math.atan2((1-n)*Math.sin(6*Math.PI*s),(1+n)*Math.cos(8*Math.PI*s+i));return.1<s&&s<.4&&h<=0&&(h+=f),-.4<s&&s<-.1&&h>=0&&(h-=f),4*h/(7*Math.PI)}function b(t,e=0,a=0){const s=t-Math.floor(t+.5),n=M(e,-1,1),i=.1*Math.PI*M(a,-.999999,.999999);let h=Math.atan2((1+n)*Math.sin(5*Math.PI*s),(1-n)*Math.cos(3*Math.PI*s+i));return s>0&&h<0&&(h+=f),s<0&&h>0&&(h-=f),h/Math.PI-s}const d=2*Math.PI;function w(t){return Math.sqrt(Math.max(0,t))}function P(t,e){return function(t,e){return e<1e-6?i(t):e>=1?h(t):(Math.hypot((1+e)*Math.cos(Math.PI*t),(1-e)*Math.sin(Math.PI*t))-1)/e}(t-.25,e)}function I(t,e){return function(t,e){return e<1e-6?n(t):e>.999999?r(t):Math.atan(e*n(t)/(1+e*i(t)))/Math.asin(e)}(t,w(e))}function y(t,e){return u(t,w(e))}function x(t,e){return l(t,w(e))}function L(t,e,a){return function(t,e,a){return e<1e-6?i(t):(Math.exp(n(t+a)*e)-Math.exp(n(t-a)*e))/((Math.exp(e)-Math.exp(-e))*n(a)*(1+(.25-a)*e))}(t,12*e,.25-.2499*a)}function D(t,e){return function(t,e){return e<1e-6?-i(t):2*(Math.cosh(Math.sin(Math.PI*t)*e)-1)/(Math.cosh(e)-1)-1}(t-.25,12*e)}function j(t,e){return function(t,e){return e<1e-6?n(t):Math.tanh(n(t)*e)/Math.tanh(e)}(t+.25,12*e)}function S(t,e){return function(t,e){if(e<1e-6)return n(t);if(e>.999999)return 1;const a=Math.log1p(-e);return(Math.log1p(n(t)*e)-a)/(Math.log1p(e)-a)*2-1}(t,.99*Math.min(1,e))}function O(t,e,a){return function(t,e,a){if(e<1e-6)return i(t);if(e>.999999)return r(t+a)-r(t-a);const s=e*n(t),h=n(a),u=e*i(t),l=i(a),f=s*l,M=u*h,c=u*l,p=s*h;return(Math.atan((f+M)/(1+c-p))-Math.atan((f-M)/(1+c+p)))*(.5+e*(o-.5))/(e*(h+(1-h)*e))}(t,w(e),.25-.24*a)}function V(t,e,a){return function(t,e,a){if(e<1e-6)return-n(t);if(e>=1)return.5*(h(t+a)-h(t-a))/n(a);const s=1+e,i=1-e,r=Math.PI*(t+a),o=Math.PI*(t-a);return(Math.hypot(s*Math.cos(r),i*Math.sin(r))-Math.hypot(s*Math.cos(o),i*Math.sin(o)))/(2*e*n(a))}(t,e,.25-.245*a)}const q=[c,p,m,v,g,b,O,V,L];function z(t,e){return t-=Math.floor(t+.5),Math.abs(t)<e?.25*t/e:t>0?.25+.25*(t-e)/(.5-e):.25*(t+e)/(.5-e)-.25}registerProcessor("monophone",class extends t{static get parameterDescriptors(){return[{name:"nat",defaultValue:0},{name:"timbre",defaultValue:0},{name:"bias",defaultValue:0}]}constructor(){super(),this.phase=0,this.differentiated=!1,this.timbre=0,this.bias=0,this.amplitude=1,this.waveform=P,this.biasable=q.includes(this.waveform),this.tables={amplitude:{linear:!1,loopStart:0,data:[1]},nat:{linear:!1,loopStart:0,data:[0]},timbre:{linear:!1,loopStart:0,data:[0]},bias:{linear:!1,loopStart:0,data:[0]}}}applyMessage(t){if(super.applyMessage(t))return;const e=t.data;if("waveform"===e.type){if("semisine"===e.value)this.waveform=P;else if("sawtooth"===e.value)this.waveform=I;else if("triangle"===e.value)this.waveform=y;else if("square"===e.value)this.waveform=x;else if("sinh"===e.value)this.waveform=L;else if("cosh"===e.value)this.waveform=D;else if("tanh"===e.value)this.waveform=j;else if("log"===e.value)this.waveform=S;else if("pulse"===e.value)this.waveform=O;else if("tent"===e.value)this.waveform=V;else if("Lissajous 2 1"===e.value)this.waveform=c;else if("Lissajous 1 3"===e.value)this.waveform=p;else if("Lissajous 2 3"===e.value)this.waveform=m;else if("Lissajous 2 5"===e.value)this.waveform=v;else if("Lissajous 3 4"===e.value)this.waveform=g;else{if("Lissajous 3 5"!==e.value)throw`Unrecognized waveform ${e.value}`;this.waveform=b}this.biasable=q.includes(this.waveform)}else{if("differentiated"!==e.type)throw`Unrecognized message ${e.type}`;this.differentiated=e.value}}processMono(t,e){let s=currentTime;const n=e.nat,i=e.timbre,h=e.bias,r=this.getDt(),o=this.getLowpass(r),u=1-o;for(let e=0;e<t.length;e++){this.triggerMessages(s);const l=this.tOnset/this.tableDelta,f=Math.exp(n[Math.min(n.length-1,e)]+a(l,this.tables.nat)),c=i[Math.min(i.length-1,e)]+a(l,this.tables.timbre),p=h[Math.min(h.length-1,e)]+a(l,this.tables.bias),m=a(l,this.tables.amplitude),v=this.timbre=this.timbre*o+c*u,g=this.bias=M(this.bias*o+p*u,0,1),b=this.amplitude=this.amplitude*o+m*u,w=f*r;let P;if(this.biasable)P=this.differentiated?(this.waveform(this.phase+w,v,g)-this.waveform(this.phase,v,g))/(w*d):.5*(this.waveform(this.phase,v,g)+this.waveform(this.phase+.5*w,v,g));else{const t=.25+.25*g;if(this.differentiated){const e=z(this.phase,t),a=z(this.phase+w,t);P=(this.waveform(a,v)-this.waveform(e,v))/(w*d)}else{const e=z(this.phase,t),a=z(this.phase+.5*w,t);P=.5*(this.waveform(e,v)+this.waveform(a,v))}}t[e]=P*b,s+=r,this.tOnset+=r,this.phase+=w,this.phase-=Math.floor(this.phase)}}});
